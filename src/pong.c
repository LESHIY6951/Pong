#include <ncurses.h>
#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <unistd.h>

void nums(int points);
void finish(int w);

int main() {
  char running, move = 1;
  int x = 40, y = 13, dx = 1, dy = 1, points_1 = 0, points_2 = 0, py_1 = 13,
      py_2 = 13;

  initscr(); // инициализация библиотеки ncurses
  noecho(); // вводимые символы не будут отображаться на экран
  curs_set(0); // делает курсор невидимым

  running = 1;
  srand((unsigned int)time(NULL));

  while (running) {
    timeout(80);
    char key = getch(); // ждём нажатия символа

    if (points_1 == 21 || points_2 == 21) {
      break;
    }
    // обработка нажатий клавиш
    if (key == 'q') {
      running = 0;
    }
    if (key == 'a') {
      if (py_1 > 1)
        py_1 -= move;
    }
    if (key == 'z') {
      if (py_1 < 23)
        py_1 += move;
    }
    if (key == 'k') {
      if (py_2 > 1)
        py_2 -= move;
    }
    if (key == 'm') {
      if (py_2 < 23)
        py_2 += move;
    }
    if (key == 'r') {
      x = 39;
      y = 13;
      dx = rand() % 2;
      dy = rand() % 2;
      if (dx == 0)
        dx = -1;
      if (dy == 0)
        dy = -1;
      points_1 = 0;
      points_2 = 0;
      move = 1;
    }
    // условия начисления баллов
    if (x >= 79) {
      if (y >= py_2 && y <= py_2 + 3) {
        dy = 1;
        dx = 1;
      } else {
        dx = -1;
        points_1++;
      }
    }
    if (x <= 1) {
      if (y >= py_1 && y <= py_1 + 3) {
        dy = 1;
        dx = 1;
      } else {
        dx = -1;
        points_2++;
      }
    }
    // физика мячика
    if (y == 1)
      dy = 1;
    if (x == 1)
      dx = 1;
    if (x == 79)
      dx = -1;
    if (y == 25)
      dy = -1;

    x = x + dx;
    y = y + dy;

    clear(); // очистить экран
    printw(" ------------------------------------------------------------------"
           "-------------\n");
    for (int i = 0; i < 25; i++) {
      printw("|                                                                "
             "               |\n");
    }
    printw(" ------------------------------------------------------------------"
           "-------------\n                                      %d | %d\n",
           points_1, points_2);
    printw("\n");
    printw("player 1 - a/z           player 2 - k/m            r - restart     "
           "     q - quit\n");
    move(y, x); // перемещение курсора в стандартном экране (y, x)
    printw("o");

    for (int i = 0; i < 3; i++) {
      move(py_1 + i, 1);
      printw("|");
    }
    for (int i = 0; i < 3; i++) {
      move(py_2 + i, 79);
      printw("|");
    }
  }
  if (points_1 > points_2)
    finish(1);
  else
    finish(2);
  echo();   // отменяет действие noecho()
  endwin(); // восстановление терминала
  return 0;
}

void finish(int w) {
  move(0, 0);
  if (w == 1) {
    printw("|***********|       |***|                 __|**|__        |***|    "
           "|***|   |***********|   |***********|    \n");
    printw("|***********|       |***|               _|********|_      |***|    "
           "|***|   |***********|   |***********|    \n");
    printw("|***|      |***|    |***|              |************|     |***|    "
           "|***|   |****|          |***|       |***|\n");
    printw("|***|      |***|    |***|            |*****|    |*****|   |***|    "
           "|***|   |****|______    |***|       |***|\n");
    printw("|***|      |***|    |***|            |*****|____|*****|   "
           "|***|____|***|   |***********|   |***********|    \n");
    printw("|***********|       |***|            |****************|   "
           "|************|   |***********|   |***********|    \n");
    printw("|***********|       |***|            |****************|           "
           "|****|   |****|          |***|     |***|\n");
    printw("|***|               |***|________    |***|        |***|           "
           "|****|   |****|______    |***|       |***|\n");
    printw("|***|               |************|   |***|        |***|   "
           "|************|   |***********|   |***|         |***|\n");
    printw("|***|               |************|   |***|        |***|   "
           "|************|   |***********|   |***|         |***|\n");
    printw("\n");
    printw("                                                     |******|\n");
    printw("                                                     |******|\n");
    printw("                                                     |******|\n");
    printw("                                                     |******|\n");
    printw("                                                     |******|\n");
    printw("                                                     |******|\n");
    printw("                                                     |******|\n");
    printw("                                                     |******|\n");
    printw("                                                     |******|\n");
    printw("                                                     |******|\n");
    printw("\n");
    printw("                           |***|     |***|     |***|   |***|      "
           "|***|               |***|   \n");
    printw("                           |***|     |***|     |***|   |***|      "
           "|***|               |***| \n");
    printw("                           |***|     |***|     |***|   |***|      "
           "|***||***|          |***| \n");
    printw("                           |***|     |***|     |***|   |***|      "
           "|***|  |***|        |***|  \n");
    printw("                           |***|     |***|     |***|   |***|      "
           "|***|    |***|      |***|  \n");
    printw("                           |***|     |***|     |***|   |***|      "
           "|***|      |***|    |***|    \n");
    printw("                           |***|     |***|     |***|   |***|      "
           "|***|        |***|  |***|    \n");
    printw("                           |***|     |***|     |***|   |***|      "
           "|***|          |***||***|   \n");
    printw("                              |*******| |*******|      |***|      "
           "|***|               |***|  \n");
    printw("                              |*******| |*******|      |***|      "
           "|***|               |***|  \n");

  } else {
    printw("|***********|       |***|                 __|**|__        |***|    "
           "|***|   |***********|   |***********|    \n");
    printw("|***********|       |***|               _|********|_      |***|    "
           "|***|   |***********|   |***********|    \n");
    printw("|***|      |***|    |***|              |************|     |***|    "
           "|***|   |****|          |***|       |***|\n");
    printw("|***|      |***|    |***|            |*****|    |*****|   |***|    "
           "|***|   |****|______    |***|       |***|\n");
    printw("|***|      |***|    |***|            |*****|____|*****|   "
           "|***|____|***|   |***********|   |***********|    \n");
    printw("|***********|       |***|            |****************|   "
           "|************|   |***********|   |***********|    \n");
    printw("|***********|       |***|            |****************|           "
           "|****|   |****|          |***|     |***|  \n");
    printw("|***|               |***|________    |***|        |***|           "
           "|****|   |****|______    |***|       |***|\n");
    printw("|***|               |************|   |***|        |***|   "
           "|************|   |***********|   |***|         |***|\n");
    printw("|***|               |************|   |***|        |***|   "
           "|************|   |***********|   |***|         |***|\n");
    printw("\n");
    printw("                                                  "
           "|****************|        \n");
    printw("                                                  "
           "|****************|         \n");
    printw("                                                            "
           "|******|         \n");
    printw("                                                            "
           "|******|         \n");
    printw("                                                  "
           "|****************|         \n");
    printw("                                                  "
           "|****************|         \n");
    printw("                                                  |******|         "
           "          \n");
    printw("                                                  |******|         "
           "          \n");
    printw("                                                  "
           "|****************|          \n");
    printw("                                                  "
           "|****************|          \n");
    printw("\n");
    printw("                           |***|     |***|     |***|   |***|      "
           "|***|               |***|   \n");
    printw("                           |***|     |***|     |***|   |***|      "
           "|***|               |***| \n");
    printw("                           |***|     |***|     |***|   |***|      "
           "|***||***|          |***| \n");
    printw("                           |***|     |***|     |***|   |***|      "
           "|***|  |***|        |***|  \n");
    printw("                           |***|     |***|     |***|   |***|      "
           "|***|    |***|      |***|  \n");
    printw("                           |***|     |***|     |***|   |***|      "
           "|***|      |***|    |***|    \n");
    printw("                           |***|     |***|     |***|   |***|      "
           "|***|        |***|  |***|    \n");
    printw("                           |***|     |***|     |***|   |***|      "
           "|***|          |***||***|   \n");
    printw("                              |*******| |*******|      |***|      "
           "|***|               |***|  \n");
    printw("                              |*******| |*******|      |***|      "
           "|***|               |***|  \n");
  }

  timeout(-1);
  getch();
}
